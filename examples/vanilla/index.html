<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Search Highlight - Vanilla JS Example</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link rel="stylesheet" href="../../dist/pdf-search-highlight.css">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1a1a2e; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  .toolbar {
    background: #16213e; padding: 12px 20px; display: flex; align-items: center; gap: 12px;
    border-bottom: 1px solid #0f3460; flex-shrink: 0; flex-wrap: wrap;
  }
  .toolbar h1 { font-size: 16px; color: #e94560; margin-right: 8px; white-space: nowrap; }

  .search-box {
    display: flex; align-items: center; background: #0f3460; border-radius: 8px;
    padding: 6px 12px; flex: 1; max-width: 400px; min-width: 200px;
  }
  .search-box input {
    background: transparent; border: none; outline: none; color: #fff; font-size: 14px; width: 100%;
  }
  .search-box input::placeholder { color: #666; }

  .nav-btns { display: flex; gap: 4px; align-items: center; }
  .nav-btns button, .upload-btn, .mode-btn {
    background: #e94560; color: #fff; border: none; border-radius: 6px;
    padding: 6px 12px; cursor: pointer; font-size: 13px; white-space: nowrap;
    transition: background 0.2s;
  }
  .nav-btns button:hover, .upload-btn:hover, .mode-btn:hover { background: #c73650; }
  .nav-btns button:disabled { background: #333; cursor: default; }
  .match-info { font-size: 13px; color: #aaa; min-width: 60px; text-align: center; }

  .options { display: flex; align-items: center; gap: 12px; }
  .options label { font-size: 12px; color: #aaa; display: flex; align-items: center; gap: 4px; cursor: pointer; }
  .options input[type="checkbox"] { accent-color: #e94560; }
  .options select { background: #0f3460; color: #e0e0e0; border: 1px solid #0f3460; border-radius: 4px; padding: 2px 4px; font-size: 12px; }

  .mode-btn.active { background: #0f3460; border: 1px solid #e94560; }

  /* Multi-context search panel */
  .multi-search-panel {
    background: #16213e; padding: 8px 20px 12px; border-bottom: 1px solid #0f3460;
    display: none; flex-shrink: 0;
  }
  .multi-search-panel.active { display: block; }
  .multi-search-panel .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .multi-search-panel .header span { font-size: 13px; color: #aaa; }

  .context-row {
    display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
  }
  .context-color {
    width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0;
  }
  .context-input {
    background: #0f3460; border: none; outline: none; border-radius: 6px;
    padding: 5px 10px; color: #fff; font-size: 13px; flex: 1; max-width: 300px;
  }
  .context-input::placeholder { color: #666; }
  .context-remove {
    background: none; border: none; color: #666; cursor: pointer; font-size: 16px;
    padding: 0 4px; line-height: 1;
  }
  .context-remove:hover { color: #e94560; }

  .add-context-btn {
    background: none; border: 1px dashed #555; color: #888; border-radius: 6px;
    padding: 4px 12px; cursor: pointer; font-size: 12px; margin-top: 4px;
    transition: all 0.2s;
  }
  .add-context-btn:hover { border-color: #e94560; color: #e94560; }

  .upload-area {
    flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px;
  }
  .drop-zone {
    border: 2px dashed #e94560; border-radius: 16px; padding: 60px 40px;
    text-align: center; cursor: pointer; transition: all 0.3s; max-width: 500px; width: 100%;
  }
  .drop-zone:hover, .drop-zone.dragover { background: rgba(233,69,96,0.1); border-color: #fff; }
  .drop-zone svg { width: 64px; height: 64px; margin-bottom: 16px; }
  .drop-zone p { font-size: 16px; margin-bottom: 8px; }
  .drop-zone span { font-size: 13px; color: #888; }

  #viewer { flex: 1; overflow-y: auto; padding: 16px; display: none; }
  #viewer.active { display: block; }
</style>
</head>
<body>

<!-- Toolbar -->
<div class="toolbar">
  <h1>PDF Search Highlight</h1>

  <!-- Single search (default mode) -->
  <div class="search-box" id="singleSearchBox">
    <input type="text" id="searchInput" placeholder="Search in PDF..." disabled />
  </div>

  <div class="nav-btns">
    <button id="prevBtn" disabled>&#9664;</button>
    <span class="match-info" id="matchInfo"></span>
    <button id="nextBtn" disabled>&#9654;</button>
  </div>

  <div class="options">
    <label><input type="checkbox" id="caseSensitive" /> Case sensitive</label>
    <label><input type="checkbox" id="fuzzyToggle" /> Fuzzy</label>
    <label>Threshold
      <select id="fuzzyThreshold" disabled>
        <option value="0.9">0.9</option>
        <option value="0.7">0.7</option>
        <option value="0.6" selected>0.6</option>
        <option value="0.4">0.4</option>
      </select>
    </label>
  </div>

  <button class="mode-btn" id="multiModeBtn" title="Toggle multi-context search">Multi</button>

  <label class="upload-btn">
    Choose PDF
    <input type="file" id="fileInput" accept=".pdf" hidden />
  </label>
</div>

<!-- Multi-context search panel -->
<div class="multi-search-panel" id="multiPanel">
  <div class="header">
    <span>Multi-context search — each query highlighted with a different color</span>
  </div>
  <div id="contextList"></div>
  <button class="add-context-btn" id="addContextBtn">+ Add context</button>
</div>

<div class="upload-area" id="uploadArea">
  <div class="drop-zone" id="dropZone">
    <svg viewBox="0 0 24 24" fill="none" stroke="#e94560" stroke-width="1.5">
      <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
      <polyline points="14,2 14,8 20,8"/>
      <line x1="12" y1="18" x2="12" y2="12"/>
      <polyline points="9,15 12,12 15,15"/>
    </svg>
    <p>Drag & drop a PDF file here</p>
    <span>or click "Choose PDF" above</span>
  </div>
</div>

<!-- PDF container -->
<div id="viewer"></div>

<script type="module">
  // Level 1 API: PDFRenderer + SearchController (separate concerns)
  import { PDFRenderer, SearchController } from '../../dist/core/index.js';

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // Context highlight colors (must match CSS highlight-0 through highlight-7)
  const CONTEXT_COLORS = [
    'rgba(255, 230, 0, 0.7)',    // Yellow
    'rgba(0, 200, 255, 0.65)',   // Cyan
    'rgba(0, 230, 120, 0.65)',   // Green
    'rgba(255, 150, 0, 0.7)',    // Orange
    'rgba(190, 100, 255, 0.65)', // Purple
    'rgba(255, 100, 150, 0.65)', // Pink
    'rgba(130, 190, 255, 0.65)', // Light Blue
    'rgba(200, 220, 100, 0.7)',  // Lime
  ];

  const viewerEl = document.getElementById('viewer');
  const searchInput = document.getElementById('searchInput');
  const singleSearchBox = document.getElementById('singleSearchBox');
  const matchInfo = document.getElementById('matchInfo');
  const uploadArea = document.getElementById('uploadArea');
  const dropZone = document.getElementById('dropZone');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const caseSensitive = document.getElementById('caseSensitive');
  const fuzzyToggle = document.getElementById('fuzzyToggle');
  const fuzzyThreshold = document.getElementById('fuzzyThreshold');
  const multiModeBtn = document.getElementById('multiModeBtn');
  const multiPanel = document.getElementById('multiPanel');
  const contextList = document.getElementById('contextList');
  const addContextBtn = document.getElementById('addContextBtn');

  let isMultiMode = false;
  let pdfLoaded = false;

  // 1) PDF Renderer — renders into #viewer
  const renderer = new PDFRenderer(viewerEl, {});
  renderer.setPdfjsLib(pdfjsLib);

  // 2) Search Controller — headless, no UI
  const search = new SearchController();

  // React to search state changes
  search.onChange = ({ current, total }) => {
    prevBtn.disabled = total === 0;
    nextBtn.disabled = total === 0;
    matchInfo.textContent = total > 0
      ? `${current + 1}/${total}`
      : (getActiveQuery() ? '0 results' : '');
  };

  function getActiveQuery() {
    if (isMultiMode) {
      return getContextInputs().some(v => v.trim());
    }
    return searchInput.value.trim();
  }

  // --- Multi-context management ---
  let contextCount = 0;

  function createContextRow() {
    const idx = contextCount++;
    const colorIdx = idx % CONTEXT_COLORS.length;

    const row = document.createElement('div');
    row.className = 'context-row';
    row.dataset.idx = String(idx);

    const color = document.createElement('div');
    color.className = 'context-color';
    color.style.background = CONTEXT_COLORS[colorIdx];

    const input = document.createElement('input');
    input.className = 'context-input';
    input.type = 'text';
    input.placeholder = `Search context ${idx + 1}...`;
    input.disabled = !pdfLoaded;
    input.addEventListener('input', debounceMultiSearch);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.shiftKey ? search.prev() : search.next();
      }
    });

    const remove = document.createElement('button');
    remove.className = 'context-remove';
    remove.textContent = '\u00d7';
    remove.addEventListener('click', () => {
      row.remove();
      runMultiSearch();
    });

    row.appendChild(color);
    row.appendChild(input);
    row.appendChild(remove);
    contextList.appendChild(row);

    if (pdfLoaded) input.focus();
    return row;
  }

  function getContextInputs() {
    return [...contextList.querySelectorAll('.context-input')].map(el => el.value);
  }

  // Initialize with 2 context rows
  function initMultiContexts() {
    contextList.innerHTML = '';
    contextCount = 0;
    createContextRow();
    createContextRow();
  }

  addContextBtn.addEventListener('click', () => {
    createContextRow();
  });

  // --- Mode toggle ---
  multiModeBtn.addEventListener('click', () => {
    isMultiMode = !isMultiMode;
    multiModeBtn.classList.toggle('active', isMultiMode);
    multiPanel.classList.toggle('active', isMultiMode);
    singleSearchBox.style.display = isMultiMode ? 'none' : '';

    search.clear();
    matchInfo.textContent = '';

    if (isMultiMode) {
      initMultiContexts();
    }
  });

  // --- File loading ---
  document.getElementById('fileInput').addEventListener('change', (e) => {
    if (e.target.files[0]) loadFile(e.target.files[0]);
  });

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const f = e.dataTransfer.files[0];
    if (f && f.type === 'application/pdf') loadFile(f);
  });

  async function loadFile(file) {
    uploadArea.style.display = 'none';
    viewerEl.classList.add('active');

    // Render PDF
    await renderer.loadDocument(file);
    const pages = await renderer.renderAllPages();

    // Connect search to rendered pages
    search.setPages(pages);

    pdfLoaded = true;
    searchInput.disabled = false;
    searchInput.focus();

    // Enable existing multi-context inputs
    contextList.querySelectorAll('.context-input').forEach(el => el.disabled = false);
  }

  // --- Search options ---
  function getSearchOptions() {
    return {
      caseSensitive: caseSensitive.checked,
      fuzzy: fuzzyToggle.checked,
      fuzzyThreshold: parseFloat(fuzzyThreshold.value),
    };
  }

  // --- Single search ---
  function runSingleSearch() {
    search.search(searchInput.value, getSearchOptions());
  }

  let debounceTimer;
  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(runSingleSearch, 250);
  });

  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.shiftKey ? search.prev() : search.next();
    }
  });

  // --- Multi search ---
  function runMultiSearch() {
    const queries = getContextInputs();
    const sharedOptions = getSearchOptions();
    const contexts = queries.map((q) => ({ query: q }));

    if (contexts.length === 0 || contexts.every(c => !c.query.trim())) {
      search.clear();
      return;
    }

    search.searchMultiple(contexts, sharedOptions);
  }

  let multiDebounceTimer;
  function debounceMultiSearch() {
    clearTimeout(multiDebounceTimer);
    multiDebounceTimer = setTimeout(runMultiSearch, 250);
  }

  // --- Shared controls ---
  caseSensitive.addEventListener('change', () => {
    isMultiMode ? runMultiSearch() : runSingleSearch();
  });

  fuzzyToggle.addEventListener('change', () => {
    fuzzyThreshold.disabled = !fuzzyToggle.checked;
    isMultiMode ? runMultiSearch() : runSingleSearch();
  });

  fuzzyThreshold.addEventListener('change', () => {
    isMultiMode ? runMultiSearch() : runSingleSearch();
  });

  prevBtn.addEventListener('click', () => search.prev());
  nextBtn.addEventListener('click', () => search.next());
</script>
</body>
</html>
